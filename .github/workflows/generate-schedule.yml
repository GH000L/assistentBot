name: üîÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–∞ –Ω–µ–¥–µ–ª—é

on:
  schedule:
    - cron: '0 0 * * 0'  # –ö–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 00:00
  workflow_dispatch:
    inputs:
      week_number:
        description: '–ù–æ–º–µ—Ä –Ω–µ–¥–µ–ª–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)'
        required: false
        default: ''

jobs:
  generate-schedule:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
      
      - name: üìÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞–Ω–¥–æ–º–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
        id: generate
        run: |
          # –°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
          SUBJECTS=(
            "–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ"
            "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"
            "–§–∏–∑–∏–∫–∞"
            "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫"
            "Web-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞"
            "–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
            "–°–µ—Ç–∏ –∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏"
            "–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã"
            "–ê–ª–≥–æ—Ä–∏—Ç–º—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö"
            "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ü–û"
            "–ú–æ–±–∏–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞"
            "–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç"
            "–ö–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å"
            "–ü—Ä–æ–µ–∫—Ç–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å"
            "–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞"
            "–≠–∫–æ–Ω–æ–º–∏–∫–∞"
            "–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è"
            "–§–∏–ª–æ—Å–æ—Ñ–∏—è"
          )
          
          # –ê—É–¥–∏—Ç–æ—Ä–∏–∏
          ROOMS=(
            "101" "102" "103" "104" "105"
            "201" "202" "203" "204" "205"
            "301" "302" "303" "304" "305"
            "–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–π –∫–ª–∞—Å—Å 1"
            "–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–π –∫–ª–∞—Å—Å 2"
            "–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è 1"
            "–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è 2"
            "–°–ø–æ—Ä—Ç–∑–∞–ª"
            "–ê–∫—Ç–æ–≤—ã–π –∑–∞–ª"
            "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞"
          )
          
          # –í—Ä–µ–º—è –ø–∞—Ä
          TIMES=(
            "8:30" "9:00" "9:30"
            "10:10" "10:40" "11:10"
            "12:00" "12:30" "13:00"
            "13:40" "14:10" "14:40"
            "15:20" "15:50" "16:20"
          )
          
          # –î–Ω–∏ –Ω–µ–¥–µ–ª–∏
          DAYS=("–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫" "–≤—Ç–æ—Ä–Ω–∏–∫" "—Å—Ä–µ–¥–∞" "—á–µ—Ç–≤–µ—Ä–≥" "–ø—è—Ç–Ω–∏—Ü–∞" "—Å—É–±–±–æ—Ç–∞")
          
          # –°–æ–∑–¥–∞–µ–º JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—É
          echo '{' > schedule.json
          
          for day_index in "${!DAYS[@]}"; do
            DAY="${DAYS[$day_index]}"
            
            # –°–ª—É—á–∞–π–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä –≤ –¥–µ–Ω—å (–æ—Ç 2 –¥–æ 6)
            NUM_CLASSES=$((2 + RANDOM % 5))
            
            echo "  \"$DAY\": [" >> schedule.json
            
            # –°–æ–∑–¥–∞–µ–º –ø–∞—Ä—ã
            for ((i=0; i<NUM_CLASSES; i++)); do
              # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
              TIME_INDEX=$((RANDOM % ${#TIMES[@]}))
              SUBJECT_INDEX=$((RANDOM % ${#SUBJECTS[@]}))
              ROOM_INDEX=$((RANDOM % ${#ROOMS[@]}))
              
              TIME="${TIMES[$TIME_INDEX]}"
              SUBJECT="${SUBJECTS[$SUBJECT_INDEX]}"
              ROOM="${ROOMS[$ROOM_INDEX]}"
              
              # –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä—É
              echo "    {\"time\": \"$TIME\", \"subject\": \"$SUBJECT\", \"room\": \"$ROOM\"}" >> schedule.json
              
              # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø—è—Ç—É—é –µ—Å–ª–∏ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–∞—Ä–∞
              if [ $i -lt $((NUM_CLASSES - 1)) ]; then
                echo "    ," >> schedule.json
              fi
            done
            
            echo "  ]" >> schedule.json
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø—è—Ç—É—é –µ—Å–ª–∏ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å
            if [ $day_index -lt $(( ${#DAYS[@]} - 1 )) ]; then
              echo "  ," >> schedule.json
            fi
          done
          
          echo '}' >> schedule.json
          
          # –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
          WEEK_NUM=$(date +%U)
          echo "–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é ‚Ññ$WEEK_NUM"
          echo "week_number=$WEEK_NUM" >> $GITHUB_OUTPUT
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
          echo "=== –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–û–ï –†–ê–°–ü–ò–°–ê–ù–ò–ï ==="
          cat schedule.json
      
      - name: üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏
        run: |
          echo "üìÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è:"
          echo "------------------------"
          for day in –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤—Ç–æ—Ä–Ω–∏–∫ —Å—Ä–µ–¥–∞ —á–µ—Ç–≤–µ—Ä–≥ –ø—è—Ç–Ω–∏—Ü–∞ —Å—É–±–±–æ—Ç–∞; do
            count=$(jq -r ".$day | length" schedule.json 2>/dev/null || echo "0")
            echo "$day: $count –ø–∞—Ä"
          done
          echo "------------------------"
          echo "–í—Å–µ–≥–æ –ø–∞—Ä –≤ –Ω–µ–¥–µ–ª—é: $(jq -r '.
          [] | length' schedule.json | awk '{sum+=$1} END{print sum}')"

                - name: üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                  run: |
                    git config --global user.email "github-actions@github.com"
                    git config --global user.name "GitHub Actions"
                    git add schedule.json
                    git commit -m "üîÑ –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–∞ –Ω–µ–¥–µ–ª—é ‚Ññ${{ steps.generate.outputs.week_number }}" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
                    git push

                - name: üì® –£–≤–µ–¥–æ–º–∏—Ç—å –æ –Ω–æ–≤–æ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏
                  uses: appleboy/telegram-action@master
                  with:
                    to: ${{ secrets.TELEGRAM_CHAT_ID }}
                    token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
                    message: |
                      üé≤ *–ù–û–í–û–ï –†–ê–°–ü–ò–°–ê–ù–ò–ï –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–û!*

                      üìÖ –ù–µ–¥–µ–ª—è ‚Ññ${{ steps.generate.outputs.week_number }}
                      üïê –î–∞—Ç–∞: $(date +"%d.%m.%Y")

                      üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:*
                      –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫: $(jq -r '.–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ | length' schedule.json) –ø–∞—Ä
                      –í—Ç–æ—Ä–Ω–∏–∫: $(jq -r '.–≤—Ç–æ—Ä–Ω–∏–∫ | length' schedule.json) –ø–∞—Ä
                      –°—Ä–µ–¥–∞: $(jq -r '.—Å—Ä–µ–¥–∞ | length' schedule.json) –ø–∞—Ä
                      –ß–µ—Ç–≤–µ—Ä–≥: $(jq -r '.—á–µ—Ç–≤–µ—Ä–≥ | length' schedule.json) –ø–∞—Ä
                      –ü—è—Ç–Ω–∏—Ü–∞: $(jq -r '.–ø—è—Ç–Ω–∏—Ü–∞ | length' schedule.json) –ø–∞—Ä
                      –°—É–±–±–æ—Ç–∞: $(jq -r '.—Å—É–±–±–æ—Ç–∞ | length' schedule.json) –ø–∞—Ä

                      üìà –í—Å–µ–≥–æ –ø–∞—Ä –Ω–∞ –Ω–µ–¥–µ–ª—é: $(jq -r '.[] | length' schedule.json | awk '{sum+=$1} END{print sum}')

                      ü§ñ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ!
                    parse_mode: markdown