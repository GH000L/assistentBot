name: –£—á–µ–±–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç

on:
  workflow_dispatch:
    inputs:
      action:
        description: '–î–µ–π—Å—Ç–≤–∏–µ'
        required: false
        default: 'schedule'
        type: choice
        options:
          - schedule
          - tasks
          - progress
          - generate_schedule
  schedule:
    - cron: '30 7 * * 1-5'
    - cron: '0 8 * * *'
    - cron: '0 20 * * 0'

jobs:
  send-notification:
    runs-on: ubuntu-latest
    steps:
      - name: –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
        if: github.event.inputs.action == 'generate_schedule'
        run: |
          echo '{
            "–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫": [
              {"time": "9:00", "subject": "Python", "room": "101"},
              {"time": "11:00", "subject": "–ê–ª–≥–æ—Ä–∏—Ç–º—ã", "room": "102"}
            ],
            "–≤—Ç–æ—Ä–Ω–∏–∫": [
              {"time": "10:00", "subject": "–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö", "room": "201"}
            ],
            "—Å—Ä–µ–¥–∞": [
              {"time": "9:00", "subject": "Web —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞", "room": "301"},
              {"time": "13:00", "subject": "JavaScript", "room": "302"}
            ],
            "—á–µ—Ç–≤–µ—Ä–≥": [
              {"time": "14:00", "subject": "React", "room": "401"}
            ],
            "–ø—è—Ç–Ω–∏—Ü–∞": [
              {"time": "10:00", "subject": "–ü—Ä–æ–µ–∫—Ç", "room": "–ö–æ–º–ø. –∫–ª–∞—Å—Å"}
            ]
          }' > schedule.json
          echo "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ"

      - name: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
        id: get_date
        run: |
          DAYS=("–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫" "–≤—Ç–æ—Ä–Ω–∏–∫" "—Å—Ä–µ–¥–∞" "—á–µ—Ç–≤–µ—Ä–≥" "–ø—è—Ç–Ω–∏—Ü–∞" "—Å—É–±–±–æ—Ç–∞" "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ")
          DAY_NUM=$(date +%u)
          DAY_INDEX=$((DAY_NUM - 1))
          DAY_RU=${DAYS[$DAY_INDEX]}
          CURRENT_DATE=$(date +"%d.%m.%Y")
          CURRENT_TIME=$(date +"%H:%M")
          WEEK_NUM=$(date +%U)
          echo "day=$DAY_RU" >> $GITHUB_OUTPUT
          echo "date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "time=$CURRENT_TIME" >> $GITHUB_OUTPUT
          echo "week=$WEEK_NUM" >> $GITHUB_OUTPUT

      - name: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
        id: check_schedule
        run: |
          DAY="${{ steps.get_date.outputs.day }}"
          if [ -f "schedule.json" ]; then
            if jq -e ".$DAY" schedule.json > /dev/null 2>&1; then
              CLASS_COUNT=$(jq -r ".$DAY | length" schedule.json)
              if [ "$CLASS_COUNT" -gt "0" ]; then
                SCHEDULE=$(jq -r ".$DAY[] | \"–í—Ä–µ–º—è: \\(.time) - \\(.subject) (–ê—É–¥. \\(.room))\"" schedule.json)
                echo "has_schedule=true" >> $GITHUB_OUTPUT
                echo "class_count=$CLASS_COUNT" >> $GITHUB_OUTPUT
                echo "schedule<<EOF" >> $GITHUB_OUTPUT
                echo "$SCHEDULE" >> $GITHUB_OUTPUT
                echo "EOF" >> $GITHUB_OUTPUT
              else
                echo "has_schedule=false" >> $GITHUB_OUTPUT
                echo "class_count=0" >> $GITHUB_OUTPUT
              fi
            else
              echo "has_schedule=false" >> $GITHUB_OUTPUT
              echo "class_count=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_schedule=false" >> $GITHUB_OUTPUT
            echo "class_count=0" >> $GITHUB_OUTPUT
          fi

      - name: –ü–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞—á–∏
        id: get_tasks
        run: |
          if [ ! -f "tasks.json" ]; then
            echo '{
              "–µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ": ["–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—á—Ç—É", "–°–¥–µ–ª–∞—Ç—å –ø–ª–∞–Ω"],
              "—É—á–µ–±–Ω—ã–µ": ["–°–¥–µ–ª–∞—Ç—å –î–ó", "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è"],
              "–ª–∏—á–Ω—ã–µ": ["–û—Ç–¥–æ—Ö–Ω—É—Ç—å", "–ü–æ–≥—É–ª—è—Ç—å"]
            }' > tasks.json
          fi
          CATEGORIES=("–µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ" "—É—á–µ–±–Ω—ã–µ" "–ª–∏—á–Ω—ã–µ")
          RANDOM_CATEGORY=${CATEGORIES[$RANDOM % ${#CATEGORIES[@]}]}
          TASKS=$(jq -r ".$RANDOM_CATEGORY[]" tasks.json)
          FORMATTED=""
          while IFS= read -r task; do
            if [ -n "$task" ]; then
              FORMATTED+="‚Ä¢ $task\n"
            fi
          done <<< "$TASKS"
          echo "tasks<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FORMATTED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "category=$RANDOM_CATEGORY" >> $GITHUB_OUTPUT

      - name: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
        id: generate_progress
        run: |
          HOURS=$((15 + RANDOM % 25))
          TASKS_DONE=$((10 + RANDOM % 20))
          PROGRESS=$((60 + RANDOM % 40))
          if [ $HOURS -ge 30 ]; then
            ACHIEVEMENT="–û—Ç–ª–∏—á–Ω–æ! $HOURS —á–∞—Å–æ–≤"
            EMOJI="üèÜ"
          elif [ $HOURS -ge 20 ]; then
            ACHIEVEMENT="–•–æ—Ä–æ—à–æ! $HOURS —á–∞—Å–æ–≤"
            EMOJI="‚≠ê"
          else
            ACHIEVEMENT="–ù–æ—Ä–º–∞–ª—å–Ω–æ! $HOURS —á–∞—Å–æ–≤"
            EMOJI="üëç"
          fi
          echo "hours=$HOURS" >> $GITHUB_OUTPUT
          echo "tasks_done=$TASKS_DONE" >> $GITHUB_OUTPUT
          echo "progress=$PROGRESS" >> $GITHUB_OUTPUT
          echo "achievement=$ACHIEVEMENT" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT

      - name: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        id: determine_message
        run: |
          if [[ "${{ github.event.inputs.action }}" == "generate_schedule" ]]; then
            echo "message_type=generated" >> $GITHUB_OUTPUT
            exit 0
          fi
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            CRON="${{ github.event.schedule }}"
            if [[ "$CRON" == "30 7 * * 1-5" ]]; then
              if [[ "${{ steps.check_schedule.outputs.has_schedule }}" == "true" ]]; then
                MSG="schedule"
              else
                MSG="no_schedule"
              fi
            elif [[ "$CRON" == "0 8 * * *" ]]; then
              MSG="tasks"
            elif [[ "$CRON" == "0 20 * * 0" ]]; then
              MSG="progress"
            fi
          else
            MSG="${{ github.event.inputs.action }}"
          fi
          echo "message_type=$MSG" >> $GITHUB_OUTPUT

      - name: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ steps.determine_message.outputs.message_type == 'generated' && '–ù–æ–≤–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ!' || '' }}
            ${{ steps.determine_message.outputs.message_type == 'schedule' && '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è' || '' }}
            ${{ steps.determine_message.outputs.message_type == 'no_schedule' && '–°–µ–≥–æ–¥–Ω—è –ø–∞—Ä –Ω–µ—Ç' || '' }}
            ${{ steps.determine_message.outputs.message_type == 'tasks' && '–ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è' || '' }}
            ${{ steps.determine_message.outputs.message_type == 'progress' && '–û—Ç—á–µ—Ç –∑–∞ –Ω–µ–¥–µ–ª—é' || '' }}
            
            –î–µ–Ω—å: ${{ steps.get_date.outputs.day }}
            –î–∞—Ç–∞: ${{ steps.get_date.outputs.date }}
            
            ${{ steps.determine_message.outputs.message_type == 'schedule' && format('\n–ü–∞—Ä —Å–µ–≥–æ–¥–Ω—è: {0}', steps.check_schedule.outputs.class_count) || '' }}
            ${{ steps.determine_message.outputs.message_type == 'schedule' && '\n' || '' }}
            ${{ steps.determine_message.outputs.message_type == 'schedule' && steps.check_schedule.outputs.schedule || '' }}
            
            ${{ steps.determine_message.outputs.message_type == 'no_schedule' && '\n–ú–æ–∂–Ω–æ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å' || '' }}
            
            ${{ steps.determine_message.outputs.message_type == 'tasks' && format('\n–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {0}', steps.get_tasks.outputs.category) || '' }}
            ${{ steps.determine_message.outputs.message_type == 'tasks' && '\n–ó–∞–¥–∞—á–∏:\n' || '' }}
            ${{ steps.determine_message.outputs.message_type == 'tasks' && steps.get_tasks.outputs.tasks || '' }}
            
            ${{ steps.determine_message.outputs.message_type == 'progress' && format('\n{0} {1}', steps.generate_progress.outputs.emoji, steps.generate_progress.outputs.achievement) || '' }}
            ${{ steps.determine_message.outputs.message_type == 'progress' && '\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:' || '' }}
            ${{ steps.determine_message.outputs.message_type == 'progress' && format('\n–ß–∞—Å–æ–≤: {0}', steps.generate_progress.outputs.hours) || '' }}
            ${{ steps.determine_message.outputs.message_type == 'progress' && format('\n–ó–∞–¥–∞—á: {0}', steps.generate_progress.outputs.tasks_done) || '' }}
            ${{ steps.determine_message.outputs.message_type == 'progress' && format('\n–ü—Ä–æ–≥—Ä–µ—Å—Å: {0}%', steps.generate_progress.outputs.progress) || '' }}
            
            ${{ steps.determine_message.outputs.message_type == 'generated' && '\n–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ' || '' }}
          parse_mode: markdown