name: ğŸ“ Ğ£Ñ‡ĞµĞ±Ğ½Ñ‹Ğ¹ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ'
        required: false
        default: 'schedule'
        type: choice
        options:
          - schedule
          - tasks
          - progress
          - generate_schedule
  schedule:
    - cron: '30 7 * * 1-5'
    - cron: '0 8 * * *'
    - cron: '0 20 * * 0'

jobs:
  send-notification:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
        uses: actions/checkout@v4

      - name: ğŸ² Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ
        if: github.event.inputs.action == 'generate_schedule'
        run: |
          echo "Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ..."
          
          python3 -c "
import json
import random

subjects = [
    'ĞŸÑ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ',
    'ĞœĞ°Ñ‚ĞµĞ¼Ğ°Ñ‚Ğ¸ĞºĞ°',
    'Ğ¤Ğ¸Ğ·Ğ¸ĞºĞ°',
    'ĞĞ½Ğ³Ğ»Ğ¸Ğ¹ÑĞºĞ¸Ğ¹',
    'Web-Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°',
    'Ğ‘Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…',
    'Ğ¡ĞµÑ‚Ğ¸',
    'ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼Ñ‹',
    'Ğ˜ÑĞºÑƒÑÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¸Ğ½Ñ‚ĞµĞ»Ğ»ĞµĞºÑ‚',
    'ĞšĞ¸Ğ±ĞµÑ€Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ'
]

rooms = ['101', '102', '201', '202', '301', '302', 'ĞšĞ¾Ğ¼Ğ¿. ĞºĞ»Ğ°ÑÑ', 'Ğ›Ğ°Ğ±Ğ¾Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¸Ñ']
times = ['9:00', '10:40', '12:30', '14:10', '15:50']
days = ['Ğ¿Ğ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº', 'Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¸Ğº', 'ÑÑ€ĞµĞ´Ğ°', 'Ñ‡ĞµÑ‚Ğ²ĞµÑ€Ğ³', 'Ğ¿ÑÑ‚Ğ½Ğ¸Ñ†Ğ°']

schedule = {}

for day in days:
    num_classes = random.randint(2, 5)
    day_schedule = []
    used_times = []

    for _ in range(num_classes):
        while True:
            time = random.choice(times)
            if time not in used_times:
                used_times.append(time)
                break

        subject = random.choice(subjects)
        room = random.choice(rooms)

        day_schedule.append({
            'time': time,
            'subject': subject,
            'room': room
        })

    day_schedule.sort(key=lambda x: x['time'])
    schedule[day] = day_schedule

with open('schedule.json', 'w', encoding='utf-8') as f:
    json.dump(schedule, f, ensure_ascii=False, indent=2)

print('Ğ Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾!')
"
          
          cat schedule.json

      - name: ğŸ“… ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ğ´ĞµĞ½ÑŒ Ğ½ĞµĞ´ĞµĞ»Ğ¸
        id: get_date
        run: |
          DAYS=("Ğ¿Ğ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº" "Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¸Ğº" "ÑÑ€ĞµĞ´Ğ°" "Ñ‡ĞµÑ‚Ğ²ĞµÑ€Ğ³" "Ğ¿ÑÑ‚Ğ½Ğ¸Ñ†Ğ°" "ÑÑƒĞ±Ğ±Ğ¾Ñ‚Ğ°" "Ğ²Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ")
          DAY_NUM=$(date +%u)
          DAY_INDEX=$((DAY_NUM - 1))
          DAY_RU=${DAYS[$DAY_INDEX]}
          
          CURRENT_DATE=$(date +"%d.%m.%Y")
          CURRENT_TIME=$(date +"%H:%M")
          WEEK_NUM=$(date +%U)
          
          echo "day=$DAY_RU" >> $GITHUB_OUTPUT
          echo "date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "time=$CURRENT_TIME" >> $GITHUB_OUTPUT
          echo "week=$WEEK_NUM" >> $GITHUB_OUTPUT

      - name: ğŸ“‹ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ
        id: check_schedule
        run: |
          DAY="${{ steps.get_date.outputs.day }}"
          
          if jq -e ".$DAY" schedule.json > /dev/null 2>&1; then
            SCHEDULE=$(jq -r ".$DAY[] | \"â° \\(.time) - \\(.subject) (Ğ°ÑƒĞ´. \\(.room))\"" schedule.json)
            CLASS_COUNT=$(jq -r ".$DAY | length" schedule.json)
            
            echo "has_schedule=true" >> $GITHUB_OUTPUT
            echo "class_count=$CLASS_COUNT" >> $GITHUB_OUTPUT
            echo "schedule<<EOF" >> $GITHUB_OUTPUT
            echo "$SCHEDULE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_schedule=false" >> $GITHUB_OUTPUT
            echo "class_count=0" >> $GITHUB_OUTPUT
          fi

      - name: âœ… ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
        id: get_tasks
        run: |
          CATEGORIES=("ĞµĞ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ñ‹Ğµ" "ÑƒÑ‡ĞµĞ±Ğ½Ñ‹Ğµ" "Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ")
          RANDOM_CATEGORY=${CATEGORIES[$RANDOM % ${#CATEGORIES[@]}]}
          
          TASKS=$(jq -r ".$RANDOM_CATEGORY[]" tasks.json 2>/dev/null || echo "ĞÑ‚Ğ´Ğ¾Ñ…Ğ½Ğ¸ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ!")
          
          FORMATTED=""
          while IFS= read -r task; do
            if [ -n "$task" ]; then
              FORMATTED+="â€¢ $task\n"
            fi
          done <<< "$TASKS"
          
          echo "tasks<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FORMATTED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "category=$RANDOM_CATEGORY" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ
        id: generate_progress
        run: |
          HOURS=$((15 + RANDOM % 25))
          TASKS_DONE=$((10 + RANDOM % 20))
          PROGRESS=$((60 + RANDOM % 40))
          
          if [ $HOURS -ge 30 ]; then
            ACHIEVEMENT="ğŸ”¥ Ğ¡ÑƒĞ¿ĞµÑ€-ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚! $HOURS Ñ‡Ğ°ÑĞ¾Ğ² ÑƒÑ‡Ñ‘Ğ±Ñ‹!"
            EMOJI="ğŸ†"
          elif [ $HOURS -ge 20 ]; then
            ACHIEVEMENT="â­ ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ°Ñ Ğ½ĞµĞ´ĞµĞ»Ñ! $HOURS Ñ‡Ğ°ÑĞ¾Ğ² ÑƒÑ‡Ñ‘Ğ±Ñ‹"
            EMOJI="â­"
          else
            ACHIEVEMENT="ğŸ‘ Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ°Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°! $HOURS Ñ‡Ğ°ÑĞ¾Ğ² ÑƒÑ‡Ñ‘Ğ±Ñ‹"
            EMOJI="ğŸ‘"
          fi
          
          echo "hours=$HOURS" >> $GITHUB_OUTPUT
          echo "tasks_done=$TASKS_DONE" >> $GITHUB_OUTPUT
          echo "progress=$PROGRESS" >> $GITHUB_OUTPUT
          echo "achievement=$ACHIEVEMENT" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT

      - name: ğŸ” ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ñ‚Ğ¸Ğ¿ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ
        id: determine_message
        run: |
          if [[ "${{ github.event.inputs.action }}" == "generate_schedule" ]]; then
            echo "message_type=generated" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            CRON="${{ github.event.schedule }}"
            
            if [[ "$CRON" == "30 7 * * 1-5" ]]; then
              if [[ "${{ steps.check_schedule.outputs.has_schedule }}" == "true" ]]; then
                MSG="schedule"
              else
                MSG="no_schedule"
              fi
            elif [[ "$CRON" == "0 8 * * *" ]]; then
              MSG="tasks"
            elif [[ "$CRON" == "0 20 * * 0" ]]; then
              MSG="progress"
            fi
          else
            MSG="${{ github.event.inputs.action }}"
          fi
          
          echo "message_type=$MSG" >> $GITHUB_OUTPUT

      - name: ğŸ“¨ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ steps.determine_message.outputs.message_type == 'generated' && 'ğŸ² *ĞĞĞ’ĞĞ• Ğ ĞĞ¡ĞŸĞ˜Ğ¡ĞĞĞ˜Ğ•!*' || '' }}
            ${{ steps.determine_message.outputs.message_type == 'schedule' && 'ğŸ“… *Ğ ĞĞ¡ĞŸĞ˜Ğ¡ĞĞĞ˜Ğ• ĞĞ Ğ¡Ğ•Ğ“ĞĞ”ĞĞ¯*' || '' }}
            ${{ steps.determine_message.outputs.message_type == 'no_schedule' && 'ğŸ‰ *Ğ¡Ğ•Ğ“ĞĞ”ĞĞ¯ ĞŸĞĞ  ĞĞ•Ğ¢!*' || '' }}
            ${{ steps.determine_message.outputs.message_type == 'tasks' && 'âœ… *Ğ¡ĞŸĞ˜Ğ¡ĞĞš Ğ”Ğ•Ğ› ĞĞ Ğ¡Ğ•Ğ“ĞĞ”ĞĞ¯*' || '' }}
            ${{ steps.determine_message.outputs.message_type == 'progress' && 'ğŸ“Š *ĞĞ¢Ğ§Ğ•Ğ¢ Ğ—Ğ ĞĞ•Ğ”Ğ•Ğ›Ğ®*' || '' }}
            
            ğŸ“† Ğ”ĞµĞ½ÑŒ: ${{ steps.get_date.outputs.day }}
            ğŸ“… Ğ”Ğ°Ñ‚Ğ°: ${{ steps.get_date.outputs.date }}
            ${{ steps.determine_message.outputs.message_type == 'progress' && format('ğŸ“ˆ ĞĞµĞ´ĞµĞ»Ñ â„–{0}', steps.get_date.outputs.week) || '' }}
            
            ${{ steps.determine_message.outputs.message_type == 'schedule' && format('\nğŸ“š *ĞŸĞ°Ñ€ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ: {0}*', steps.check_schedule.outputs.class_count) || '' }}
            ${{ steps.determine_message.outputs.message_type == 'schedule' && '\n' || '' }}
            ${{ steps.determine_message.outputs.message_type == 'schedule' && steps.check_schedule.outputs.schedule || '' }}

            ${{ steps.determine_message.outputs.message_type == 'no_schedule' && '\nğŸ¯ *ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ·Ğ°Ğ½ÑÑ‚ÑŒÑÑ:*\nâ€¢ Ğ¡Ğ°Ğ¼Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼\nâ€¢ ĞŸÑ€Ğ¾ĞµĞºÑ‚Ğ°Ğ¼Ğ¸\nâ€¢ ĞÑ‚Ğ´Ñ‹Ñ…Ğ¾Ğ¼\nâ€¢ Ğ¥Ğ¾Ğ±Ğ±Ğ¸\n' || '' }}

            ${{ steps.determine_message.outputs.message_type == 'tasks' && format('\nğŸ“‚ ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ: {0}', steps.get_tasks.outputs.category) || '' }}
            ${{ steps.determine_message.outputs.message_type == 'tasks' && '\nğŸ“ *Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸:*\n' || '' }}
            ${{ steps.determine_message.outputs.message_type == 'tasks' && steps.get_tasks.outputs.tasks || '' }}

            ${{ steps.determine_message.outputs.message_type == 'progress' && format('\n{0} *{1}*', steps.generate_progress.outputs.emoji, steps.generate_progress.outputs.achievement) || '' }}
            ${{ steps.determine_message.outputs.message_type == 'progress' && '\nğŸ“ˆ *Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°:*' || '' }}
            ${{ steps.determine_message.outputs.message_type == 'progress' && format('\nâ° Ğ§Ğ°ÑĞ¾Ğ² ÑƒÑ‡Ñ‘Ğ±Ñ‹: {0}', steps.generate_progress.outputs.hours) || '' }}
            ${{ steps.determine_message.outputs.message_type == 'progress' && format('\nâœ… Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾ Ğ·Ğ°Ğ´Ğ°Ñ‡: {0}', steps.generate_progress.outputs.tasks_done) || '' }}
            ${{ steps.determine_message.outputs.message_type == 'progress' && format('\nğŸ“Š ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ: {0}%', steps.generate_progress.outputs.progress) || '' }}
            ${{ steps.determine_message.outputs.message_type == 'progress' && '\n\nğŸ’ª *Ğ¢Ğ°Ğº Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ!*' || '' }}

            ${{ steps.determine_message.outputs.message_type == 'generated' && '\nğŸ¯ *ĞĞ¾Ğ²Ğ¾Ğµ Ñ€Ğ°Ğ½Ğ´Ğ¾Ğ¼Ğ½Ğ¾Ğµ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾!*' || '' }}
            ${{ steps.determine_message.outputs.message_type == 'generated' && '\nğŸ“… ĞĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ÑÑ ĞºĞ°Ğ¶Ğ´Ğ¾Ğµ Ğ²Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ.' || '' }}
            ${{ steps.determine_message.outputs.message_type == 'generated' && '\nğŸ¤– Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ñƒ Ğ²Ğ°Ñ Ğ²ÑĞµĞ³Ğ´Ğ° ÑĞ²ĞµĞ¶ĞµĞµ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ!' || '' }}

            ---
            ğŸ² *MyStudyAssistantBot Ñ Ñ€Ğ°Ğ½Ğ´Ğ¾Ğ¼Ğ½Ñ‹Ğ¼ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸ĞµĞ¼*
            ğŸ• ${{ steps.get_date.outputs.time }}
          parse_mode: markdown